<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Timetable Import Preview â€¢ Clash Detection (Light v6)</title>
  <style>
    :root{
      --header-h: 120px;
      --bg: #f7f9fc;
      --panel: #ffffff;
      --text: #0f172a;
      --muted: #475569;
      --slot-height: 24px; /* baseline slot height (auto-scales) */
      --col-width: 230px;
      --radius: 14px;
      --shadow: 0 10px 28px rgba(2,6,23,0.08);
      --grid-border: #e5e7eb;
      --accent: #2563eb;
      --warn: #f59e0b;
    }
    *{box-sizing:border-box}
    body{ margin:0; font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; color:var(--text); background:var(--bg); }
    header{ position: sticky; top:0; z-index: 60; background: linear-gradient(180deg, rgba(255,255,255,0.98), rgba(255,255,255,0.94)); backdrop-filter: blur(4px); border-bottom:1px solid var(--grid-border); padding: 16px 18px 12px; }
    .title-row{ display:flex; gap:12px; align-items:center; justify-content:space-between; }
    .title{ font-size:20px; font-weight:700 }
    .sub{ color:var(--muted); font-size:13px; margin-top:4px }

    .bar{ margin-top:12px; display:grid; gap:10px; grid-template-columns: 1.1fr repeat(6, 1fr) 1fr; align-items:end; }
    .control{ background:var(--panel); border:1px solid var(--grid-border); border-radius:12px; padding:10px 12px; box-shadow: var(--shadow); }
    label{ display:block; font-size:12px; color:var(--muted); margin-bottom:6px }
    select,input[type="file"]{ width:100%; background:#fff; border:1px solid #dde3ee; color:var(--text); padding:8px 10px; border-radius:10px; outline:none; }
    .btn{ display:inline-flex; align-items:center; justify-content:center; gap:8px; border:1px solid #c7d2fe; background:linear-gradient(180deg,#eef2ff,#e0e7ff); color:#1e3a8a; padding:10px 12px; border-radius:12px; font-weight:600; cursor:pointer; text-decoration:none; }
    .btn.ghost{ background:#fff; border-color:#e5e7eb; color:#0f172a; }
    .checkboxes{ display:flex; gap:12px; align-items:center; flex-wrap:wrap; color:var(--muted); font-size:12px; margin-top:10px }
    .checkboxes label{ display:flex; align-items:center; gap:6px; margin:0; }

    .legend{ margin: 14px auto; width: calc(80px + 7*var(--col-width)); display:flex; gap:16px; align-items:center; color:var(--muted); font-size:12px; }
    .dot{ width:12px; height:12px; border-radius:50%; display:inline-block; margin-right:6px; }
    .dot.normal{ background:#c7d2fe; border:1px solid #93c5fd; }
    .dot.clash{ background:#fde68a; border:1px solid #f59e0b; }

    .days-sticky{ position: sticky; top: var(--header-h); z-index: 55; width: calc(80px + 7*var(--col-width)); margin: 0 auto; display: grid; grid-template-columns: 80px repeat(7, var(--col-width)); background: #fff; border: 1px solid var(--grid-border); border-bottom: none; border-top-left-radius: var(--radius); border-top-right-radius: var(--radius); box-shadow: var(--shadow); }
    .days-sticky.fixed{ position: fixed; left: 50%; transform: translateX(-50%); top: var(--header-h); margin:0; }
    .days-sticky .cell{ padding: 10px; font-weight:700; font-size:14px; text-align:center; border-right:1px solid var(--grid-border); background:#fff; }
    .days-sticky .cell.time{ text-align:left; }
    .days-sticky .cell:last-child{ border-right:none; }
    #daysSpacer{ height: 0px; }

    .calendar-wrap{ width: calc(80px + 7*var(--col-width)); margin: 0 auto 80px auto; display: grid; grid-template-columns: 80px repeat(7, var(--col-width)); gap:0; border: 1px solid var(--grid-border); border-top: none; border-bottom-left-radius: var(--radius); border-bottom-right-radius: var(--radius); background: #fff; overflow: hidden; box-shadow: var(--shadow); }
    .time-col{ grid-column: 1; background: #fcfcfd; position: relative; }
    .time-label{ height: calc(4 * var(--slot-height)); font-size:11px; padding:4px 8px; color: var(--muted); border-bottom:1px dashed #e5e7eb; display:flex; align-items:center; justify-content:flex-end; }
    .day-col{ position:relative; border-left:1px solid var(--grid-border); background: repeating-linear-gradient(to bottom, transparent 0, transparent calc(var(--slot-height) - 1px), rgba(2,6,23,0.05) calc(var(--slot-height) - 1px), rgba(2,6,23,0.05) var(--slot-height)); }
    .event{ position:absolute; left:8px; right:8px; border-radius:10px; padding:8px 10px; border:1px solid #bfdbfe; background: linear-gradient(180deg, #eff6ff, #e0f2fe); font-size:12px; cursor:pointer; box-shadow: 0 6px 14px rgba(2,6,23,0.08); overflow: visible; }
    .event .title{ font-weight:700; font-size:12px; margin-bottom:3px; color:#0f172a; }
    .event .meta{ font-size:11px; color:#334155; }
    .event.clash{ border-color:#f59e0b; background: linear-gradient(180deg, #fff7ed, #fffbeb); }
    .count-badge{ position:absolute; top:6px; right:6px; min-width:22px; height:22px; line-height:22px; padding:0 6px; border-radius:999px; font-size:12px; background:#e2e8f0; border:1px solid #cbd5e1; text-align:center; cursor:pointer; }
    .count-badge.clash{ background:#fde68a; border-color:#f59e0b; }

    .modal-backdrop{ position:fixed; inset:0; background: rgba(2,6,23,0.35); display:none; align-items:center; justify-content:center; z-index: 70; }
    .modal{ width:min(900px,92vw); max-height:85vh; overflow:auto; background:#fff; border:1px solid var(--grid-border); border-radius:16px; box-shadow: var(--shadow); padding:16px; }
    .modal h3{ margin:6px 0 12px; }
    .pill{ display:inline-block; padding:2px 8px; border-radius:999px; border:1px solid #e2e8f0; background:#f8fafc; color:#0f172a; font-size:11px; margin-right:6px; margin-bottom:6px; }
    table{ border-collapse:collapse; width:100%; font-size:12px; margin-top:8px; border:1px solid var(--grid-border); }
    th,td{ padding:6px 8px; border-bottom:1px solid var(--grid-border); text-align:left; }
    th{ background:#f8fafc; position:sticky; top:0; }
    .muted{ color:var(--muted); }

    .toast{ position: fixed; bottom: 18px; right: 18px; background: #111827; color: #fff; padding: 10px 12px; border-radius: 10px; box-shadow: var(--shadow); font-size:12px; display:none; }

    /* Ask AI */
    #askAiBtn{ display:inline-flex; align-items:center; gap:8px; }
    .ai-chip{ background:#e0f2fe; color:#075985; border:1px solid #bae6fd; border-radius:999px; padding:6px 10px; font-weight:600; cursor:pointer; }
    .ai-modal .row{ display:grid; grid-template-columns: 1fr; gap:10px; margin-top:8px; }
    .ai-modal textarea{ width:100%; min-height:120px; padding:10px; border-radius:10px; border:1px solid #e5e7eb; }
    .ai-modal input[type="password"], .ai-modal input[type="text"]{ width:100%; padding:10px; border-radius:10px; border:1px solid #e5e7eb; }
    .ai-output{ white-space:pre-wrap; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; font-size:14px; background:#f8fafc; border:1px solid #e5e7eb; border-radius:12px; padding:12px; margin-top:10px; min-height:80px; }
  </style>
</head>
<body>
  <header id="pageHeader">
    <div class="title-row">
      <div>
        <div class="title">Timetable Import Preview â€¢ Clash Detection</div>
        <div class="sub">Upload a revised Excel. Parses 12-hour slots and Excel time cells; adds Curriculum & Semester filters.</div>
      </div>
      <div>
        <button id="askAiBtn" class="ai-chip">ðŸ¤– Ask AI</button>
      </div>
    </div>

    <div class="bar">
      <div class="control"><label>Upload Excel (.xlsx)</label><input id="fileInput" type="file" accept=".xlsx,.xls"/></div>
      <div class="control"><label>Curriculum</label><select id="filterCurriculum"><option value="">All</option></select></div>
      <div class="control"><label>Semester</label><select id="filterSemester"><option value="">All</option></select></div>
      <div class="control"><label>Section</label><select id="filterSection"><option value="">All</option></select></div>
      <div class="control"><label>Teacher</label><select id="filterTeacher"><option value="">All</option></select></div>
      <div class="control"><label>Course</label><select id="filterCourse"><option value="">All</option></select></div>
      <div class="control"><label>Room</label><select id="filterRoom"><option value="">All</option></select></div>
      <div class="control">
        <label>Day</label>
        <select id="filterDay">
          <option value="">All</option>
          <option>Mon</option><option>Tue</option><option>Wed</option>
          <option>Thu</option><option>Fri</option><option>Sat</option><option>Sun</option>
        </select>
      </div>
      <div class="control"><label>Where is clash?</label>
        <select id="filterClash">
          <option value="">All items</option>
          <option value="clash">Clash only</option>
          <option value="no-clash">Non-clashing only</option>
        </select>
      </div>
      <div class="control"><button id="btnDownload" class="btn">Download Conflicts CSV</button></div>
    </div>
    <div class="checkboxes">
      <label><input type="checkbox" id="byTeacher" checked/> Clash by <b>Teacher</b></label>
      <label><input type="checkbox" id="byRoom" checked/> Clash by <b>Room</b></label>
      <label><input type="checkbox" id="bySection"/> Clash by <b>Section</b></label>
    </div>
  </header>

  <div class="legend">
    <span><span class="dot normal"></span>Normal</span>
    <span><span class="dot clash"></span>Clash</span>
  </div>

  <div id="daysBar" class="days-sticky">
    <div class="cell time">Time</div>
    <div class="cell">Mon</div><div class="cell">Tue</div><div class="cell">Wed</div>
    <div class="cell">Thu</div><div class="cell">Fri</div><div class="cell">Sat</div><div class="cell">Sun</div>
  </div>
  <div id="daysSpacer"></div>

  <div id="calendar" class="calendar-wrap"></div>

  <div id="modal" class="modal-backdrop">
    <div class="modal">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <h3 id="modalTitle">Details</h3>
        <button id="closeModal" class="btn">Close</button>
      </div>
      <div id="modalContent"></div>
    </div>
  </div>

  <!-- Ask AI Modal -->
  <div id="aiModal" class="modal-backdrop">
    <div class="modal ai-modal">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <h3>Ask AI about this timetable</h3>
        <button id="closeAiModal" class="btn ghost">Close</button>
      </div>
      <div class="row">
        <label>OpenAI API Key (stored locally in your browser)</label>
        <div style="display:flex; gap:8px; align-items:center;">
          <input id="apiKeyInput" type="password" placeholder="sk-..." style="flex:1"/>
          <button id="saveKeyBtn" class="btn">Save Key</button>
          <button id="clearKeyBtn" class="btn ghost">Clear</button>
        </div>
      </div>
      <div class="row">
        <label>Your question</label>
        <textarea id="aiPrompt" placeholder="e.g., Summarize teacher clashes on Thu 10 AMâ€“1 PM for Curriculum X, Semester Y..."></textarea>
      </div>
      <div class="row" style="display:flex; gap:8px; align-items:center;">
        <button id="askBtn" class="btn">Ask</button>
        <span id="aiStatus" class="muted"></span>
      </div>
      <div id="aiOutput" class="ai-output"></div>
      <div class="muted" style="margin-top:10px">Tip: Your key is used only from your browser to call OpenAI directly. For production, use a server-side proxy so your key stays secret.</div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script>
    // --- header height & sticky/fixed controller for Days bar ---
    const pageHeader = document.getElementById("pageHeader");
    const daysBar = document.getElementById("daysBar");
    const daysSpacer = document.getElementById("daysSpacer");
    function setHeaderHeight(){
      const h = pageHeader.offsetHeight;
      document.documentElement.style.setProperty("--header-h", h + "px");
      if(daysBar.classList.contains("fixed")) daysSpacer.style.height = daysBar.offsetHeight + "px";
    }
    function updateDaysBarMode(){
      const headerH = pageHeader.offsetHeight;
      const barTop = daysBar.getBoundingClientRect().top + window.scrollY;
      const shouldFix = window.scrollY >= (barTop - headerH - 1);
      if(shouldFix){
        if(!daysBar.classList.contains("fixed")){
          daysBar.classList.add("fixed");
          daysSpacer.style.height = daysBar.offsetHeight + "px";
        }
      }else{
        if(daysBar.classList.contains("fixed")){
          daysBar.classList.remove("fixed");
          daysSpacer.style.height = "0px";
        }
      }
    }
    window.addEventListener("load", () => { setHeaderHeight(); updateDaysBarMode(); });
    window.addEventListener("resize", () => { setHeaderHeight(); updateDaysBarMode(); });

    // ===== Helpers =====
    const DAY_ORDER = ["Mon","Tue","Wed","Thu","Fri","Sat","Sun"];
    const SLOT_MINUTES = 15;
    const DEFAULT_SLOT_PX = 24; // baseline we will scale from

    const showToast = (msg) => {
      const t = document.getElementById("toast");
      t.textContent = msg;
      t.style.display = "block";
      setTimeout(() => t.style.display = "none", 3500);
    };

    const normDay = (d) => {
      if(d==null) return null;
      d = (""+d).trim();
      const map = {Mon:"Mon", MON:"Mon", Monday:"Mon", MONDAY:"Mon",
                   Tue:"Tue", TUE:"Tue", Tuesday:"Tue", TUESDAY:"Tue",
                   Wed:"Wed", WED:"Wed", Wednesday:"Wed", WEDNESDAY:"Wed",
                   Thu:"Thu", THU:"Thu", Thur:"Thu", Thurs:"Thu", THURSDAY:"Thu",
                   Fri:"Fri", FRI:"Fri", Friday:"Fri", FRIDAY:"Fri",
                   Sat:"Sat", SAT:"Sat", Saturday:"Sat", SATURDAY:"Sat",
                   Sun:"Sun", SUN:"Sun", Sunday:"Sun", SUNDAY:"Sun"};
      if(map[d]) return map[d];
      return d.slice(0,3).charAt(0).toUpperCase()+d.slice(1,3).toLowerCase();
    };

    function excelTimeToMinutes(v){
      const frac = v - Math.floor(v);
      return Math.round(frac * 24 * 60);
    }

    function parseTimeCell(val){
      if(val==null || val==="") return null;
      if(typeof val === "number"){ return excelTimeToMinutes(val); }
      if(val instanceof Date){ return val.getHours()*60 + val.getMinutes(); }
      const s = String(val).trim();
      let m = s.match(/^(\d{1,2})(?::(\d{2}))?\s*([AP]M)$/i);
      if(m){
        const hh = parseInt(m[1],10)%12, mm = parseInt(m[2]||"0",10);
        const h24 = m[3].toUpperCase()==="PM" ? hh+12 : hh;
        return h24*60 + mm;
      }
      m = s.match(/^(\d{1,2}):(\d{2})(?::\d{2})?$/);
      if(m){
        const hh = parseInt(m[1],10), mm = parseInt(m[2],10);
        return hh*60 + mm;
      }
      return null;
    }

    function parseSlot(val){
      if(!val) return [null,null];
      const s = String(val).trim();
      const re = /(\d{1,2})(?::(\d{2}))?\s*([AP]M)\s*(?:to|-|â€“)\s*(\d{1,2})(?::(\d{2}))?\s*([AP]M)/i;
      const m = s.match(re);
      if(!m) return [null,null];
      const sh = parseInt(m[1],10)%12, sm = parseInt(m[2]||"0",10), sampm = m[3].toUpperCase();
      const eh = parseInt(m[4],10)%12, em = parseInt(m[5]||"0",10), eampm = m[6].toUpperCase();
      const s24 = (sampm==="PM"?sh+12:sh)*60 + sm;
      const e24 = (eampm==="PM"?eh+12:eh)*60 + em;
      return [s24,e24];
    }

    const mmToHHMM12 = (mins) => {
      const h24 = Math.floor(mins/60);
      const m = mins % 60;
      const ampm = h24 >= 12 ? "PM" : "AM";
      const h12 = h24 % 12 === 0 ? 12 : h24 % 12;
      const pad = (x) => String(x).padStart(2, "0");
      return `${pad(h12)}:${pad(m)} ${ampm}`;
    };

    const overlap = (aS,aE,bS,bE) => (aS < bE) && (bS < aE);
    const escapeHtml = (str)=> (str||"").replace(/[&<>"']/g, s => ({"&":"&amp;","<":"&lt;","&quot;":"&quot;","'":"&#39;",">":"&gt;"}[s]));
    const groupBy = (arr, fn) => { const m={}; arr.forEach(x=>{ const k=fn(x)||""; (m[k]=m[k]||[]).push(x); }); return m; };
    const normKey = (s) => (s==null?"":String(s).trim().replace(/\s+/g," ")).toLowerCase();
    const isBreak = (e) => {
      const r = (e.room||"").toString().trim().toUpperCase();
      return r === "BREAK" || (e.course||"").trim() === "";
    };

    // ===== State =====
    let events = []; let conflicts = []; let conflictClustersByDay = {};

    // ===== UI Inputs =====
    const byTeacher = document.getElementById("byTeacher");
    const byRoom = document.getElementById("byRoom");
    const bySection = document.getElementById("bySection");
    [byTeacher, byRoom, bySection].forEach(el => el.addEventListener("change", () => { computeConflicts(); renderCalendar(); }));

    document.getElementById("fileInput").addEventListener("change", handleFile, false);
    async function handleFile(ev){
      const file = ev.target.files[0];
      if(!file) return;
      const data = await file.arrayBuffer();
      const wb = XLSX.read(data, {cellDates: true});

      // Detect sheets that look like the timetable export format
      const candidateSheets = [];
      const requiredCols = ["CURRICULUM","COURSE","SEMESTER","SECTION","TEACHER"]; // minimal id columns
      for(const name of wb.SheetNames){
        const sheet = wb.Sheets[name];
        const jsonHead = XLSX.utils.sheet_to_json(sheet, {header:1, range:0, blankrows:false});
        const headers = (jsonHead[0]||[]).map(h => String(h||"").trim());
        const hasIdCols = requiredCols.every(c => headers.includes(c));
        const hasDayCols = headers.some(h => /^DAY\d+$/i.test(h)) || headers.some(h => /^DAY\d+_TIME_FROM$/i.test(h)) || headers.some(h => /^DAY\d+_TIME_SLOT$/i.test(h));
        if(hasIdCols && hasDayCols) candidateSheets.push(name);
      }

      // Prefer a sheet explicitly named "TimeTable" if present
      let sheetsToRead = candidateSheets;
      if(wb.SheetNames.includes("TimeTable")) sheetsToRead = ["TimeTable"]; // single source of truth
      if(!sheetsToRead.length) sheetsToRead = [wb.SheetNames[0]]; // fallback

      const out = [];
      const sheetLoadCounts = [];
      sheetsToRead.forEach((shName) => {
        const json = XLSX.utils.sheet_to_json(wb.Sheets[shName], {defval: "", raw: false});
        let countBefore = out.length;
        json.forEach((row, idx) => {
          const base = {
            startdate: row["STARTDATE"] || "",
            enddate: row["ENDDATE"] || "",
            curriculum: String(row["CURRICULUM"]||"").trim(),
            course: String(row["COURSE"]||"").trim(),
            semester: String(row["SEMESTER"]||"").trim(),
            section: String(row["SECTION"]||"").trim(),
            teacher: String(row["TEACHER"]||"").trim()
          };
          for(let i=1;i<=8;i++){ // up to DAY8 if present
            const day = normDay(row[`DAY${i}`]);
            if(!day) continue;

            let s=null, e=null;
            const from = row[`DAY${i}_TIME_FROM`];
            const to = row[`DAY${i}_TIME_TO`];
            const slot = row[`DAY${i}_TIME_SLOT`];
            if(slot){ [s,e] = parseSlot(slot); }
            if((s==null || e==null) && (from || to)){
              s = parseTimeCell(from);
              e = parseTimeCell(to);
            }
            if(s==null || e==null) continue;

            const room = String(row[`DAY${i}_ROOM`]||"").trim() || null;
            const link = String(row[`DAY${i}_LINK`]||"").trim() || null;

            out.push({ id: `${shName}-${idx}-${i}`, ...base, day, start: s, end: e, room, link });
          }
        });
        sheetLoadCounts.push({name: shName, count: out.length - countBefore});
      });

      events = out;
      populateFilters();
      computeConflicts();
      renderCalendar();

      if(!events.length){
        showToast("Uploaded âœ“ but I couldnâ€™t parse any time slots. Check DAYn + TIME columns or TIME_SLOT text.");
      }else{
        const parts = sheetLoadCounts.map(x=>`${x.name}: ${x.count}`).join(", ");
        showToast(`Loaded ${events.length} events from sheets [${parts}].`);
      }
    }

    function getClashKeys(){
      const keys = [];
      if(byTeacher.checked) keys.push("teacher");
      if(byRoom.checked) keys.push("room");
      if(bySection.checked) keys.push("section");
      return keys;
    }

    function computeConflicts(){
      conflicts = [];
      const keys = getClashKeys();
      // Exclude BREAK entries from clash computation
      const clashEvents = events.filter(e => !isBreak(e));
      const byDay = groupBy(clashEvents, e=>e.day);
      for(const day of Object.keys(byDay)){
        const list = byDay[day].slice().sort((a,b)=>a.start-b.start);
        keys.forEach(k => addClashes(list, k, `${k.toUpperCase()}_CLASH`));
      }
      conflictClustersByDay = {};
      for(const day of Object.keys(byDay)){
        const idsInClash = new Set();
        conflicts.filter(c => c.day===day).forEach(c => { idsInClash.add(c.a.id); idsInClash.add(c.b.id); });
        const conflicted = byDay[day].filter(e => idsInClash.has(e.id)).sort((a,b)=>a.start-b.start);
        conflictClustersByDay[day] = buildClusters(conflicted);
      }
    }

    function addClashes(list, key, label){
      const byKey = groupBy(list.filter(e => !!e[key]), e => e[key]);
      for(const k of Object.keys(byKey)){
        const arr = byKey[k].slice().sort((a,b)=>a.start-b.start);
        for(let i=0;i<arr.length;i++){
          for(let j=i+1;j<arr.length;j++){
            if(overlap(arr[i].start, arr[i].end, arr[j].start, arr[j].end)){
              conflicts.push({type: label, day: arr[i].day, key: k, a: arr[i], b: arr[j], suggestions: suggestFixes(arr[i], arr[j])});
            }
          }
        }
      }
    }

    function buildClusters(list){
      const intervals = list.map(e=>({start:e.start, end:e.end, member:e})).sort((a,b)=>a.start-b.start);
      const merged = [];
      for(const iv of intervals){
        if(!merged.length) merged.push({start:iv.start, end:iv.end, members:[iv.member]});
        else{
          const last = merged[merged.length-1];
          if(overlap(last.start,last.end,iv.start,iv.end)){
            last.end = Math.max(last.end, iv.end);
            last.members.push(iv.member);
          }else{
            merged.push({start:iv.start, end:iv.end, members:[iv.member]});
          }
        }
      }
      return merged.filter(c=>c.members.length>1);
    }

    function suggestFixes(a,b){
      const suggestions = {};
      const rooms = Array.from(new Set(events.map(e=>e.room).filter(Boolean))).sort();
      const isRoomFree = (room, day, s, e) => events.filter(x=>x.day===day && x.room===room).every(x => !overlap(x.start,x.end,s,e));
      const tFree = (teacher, day, s, e) => events.filter(x=>x.day===day && x.teacher===teacher).every(x => !overlap(x.start,x.end,s,e));
      const nextAvailable = (teacher, room, day, s, e) => {
        const dur = e - s;
        const starts = Array.from(new Set(events.map(x=>x.start))).sort((a,b)=>a-b);
        for(const st of starts){
          const ed = st + dur;
          if(ed>24*60) continue;
          if(tFree(teacher, day, st, ed) && (!room || isRoomFree(room, day, st, ed))) return {day, start:mmToHHMM12(st), end:mmToHHMM12(ed)};
        }
        const idx = DAY_ORDER.indexOf(day);
        if(idx>=0){
          for(const delta of [-1,1,-2,2]){
            const d2 = DAY_ORDER[(idx+delta+7)%7];
            if(tFree(teacher, d2, s, e) && (!room || isRoomFree(room, d2, s, e))) return {day:d2, start:mmToHHMM12(s), end:mmToHHMM12(e)};
          }
        }
        return null;
      };
      const freeRoomsA = rooms.filter(r => isRoomFree(r, a.day, a.start, a.end));
      if(freeRoomsA.length) suggestions.alt_room_same_time_for_a = freeRoomsA.slice(0,3);
      const freeRoomsB = rooms.filter(r => isRoomFree(r, b.day, b.start, b.end));
      if(freeRoomsB.length) suggestions.alt_room_same_time_for_b = freeRoomsB.slice(0,3);
      const naA = nextAvailable(a.teacher, a.room, a.day, a.start, a.end);
      if(naA) suggestions.next_available_for_a = naA;
      const naB = nextAvailable(b.teacher, b.room, b.day, b.start, b.end);
      if(naB) suggestions.next_available_for_b = naB;
      return suggestions;
    }

    // ===== Filters =====
    function populateFilters(){
      const getOpts = (key) => Array.from(new Set(events.map(e=>e[key]).filter(Boolean))).sort();
      fillSelect("filterCurriculum", getOpts("curriculum"));
      fillSelect("filterSemester", getOpts("semester"));
      fillSelect("filterSection", getOpts("section"));
      fillSelect("filterTeacher", getOpts("teacher"));
      fillSelect("filterCourse", getOpts("course"));
      fillSelect("filterRoom", getOpts("room"));
    }
    function fillSelect(id, values){
      const sel = document.getElementById(id);
      const keep = sel.value;
      sel.innerHTML = '<option value="">All</option>' + values.map(v=>`<option>${escapeHtml(v)}</option>`).join("");
      if(values.includes(keep)) sel.value = keep;
    }
    function getFilters(){
      return {
        curriculum: document.getElementById("filterCurriculum").value,
        semester: document.getElementById("filterSemester").value,
        section: document.getElementById("filterSection").value,
        teacher: document.getElementById("filterTeacher").value,
        course: document.getElementById("filterCourse").value,
        room: document.getElementById("filterRoom").value,
        day: document.getElementById("filterDay").value,
        clash: document.getElementById("filterClash").value
      };
    }
    ["filterCurriculum","filterSemester","filterSection","filterTeacher","filterCourse","filterRoom","filterDay","filterClash"].forEach(id => {
      document.getElementById(id).addEventListener("change", renderCalendar);
    });

    function applyFilters(list){
      const f = getFilters();
      let out = list;
      if(f.curriculum) out = out.filter(e=>normKey(e.curriculum)===normKey(f.curriculum));
      if(f.semester) out = out.filter(e=>normKey(e.semester)===normKey(f.semester));
      if(f.section) out = out.filter(e=>normKey(e.section)===normKey(f.section));
      if(f.teacher) out = out.filter(e=>normKey(e.teacher)===normKey(f.teacher));
      if(f.course) out = out.filter(e=>normKey(e.course)===normKey(f.course));
      if(f.room) out = out.filter(e=>normKey(e.room)===normKey(f.room));
      if(f.day) out = out.filter(e=>e.day===f.day);
      if(f.clash){
        const idsInClash = new Set(); conflicts.forEach(c=>{ idsInClash.add(c.a.id); idsInClash.add(c.b.id); });
        if(f.clash==="clash") out = out.filter(e=>idsInClash.has(e.id));
        if(f.clash==="no-clash") out = out.filter(e=>!idsInClash.has(e.id));
      }
      return out;
    }

    // ===== Calendar body rendering =====
    function renderCalendar(){
      const cal = document.getElementById("calendar");
      cal.innerHTML = "";

      if(!events.length){
        cal.innerHTML = `<div style="grid-column: 1 / -1; padding: 24px; text-align: center; color: var(--muted);">
          Upload an Excel file to preview the calendar.</div>`;
        return;
      }

      // Reset slot height to baseline before we measure
      document.documentElement.style.setProperty("--slot-height", DEFAULT_SLOT_PX + "px");

      const filteredEvents = applyFilters(events);
      const minStart = Math.min(...filteredEvents.map(e=>e.start));
      const maxEnd = Math.max(...filteredEvents.map(e=>e.end));
      const gridStart = Math.floor(minStart / SLOT_MINUTES) * SLOT_MINUTES;
      const gridEnd = Math.ceil(maxEnd / SLOT_MINUTES) * SLOT_MINUTES;
      const totalSlots = (gridEnd - gridStart) / SLOT_MINUTES;

      // Time column labels (12h)
      const tcol = document.createElement("div");
      tcol.className = "time-col";
      tcol.style.gridRow = `1 / span ${totalSlots}`;
      for(let m=gridStart; m<gridEnd; m+=60){
        const lab = document.createElement("div");
        lab.className = "time-label";
        lab.textContent = mmToHHMM12(m);
        tcol.appendChild(lab);
      }
      cal.appendChild(tcol);

      const idsInClash = new Set(); conflicts.forEach(c => { idsInClash.add(c.a.id); idsInClash.add(c.b.id); });

      DAY_ORDER.forEach((day, colIdx) => {
        const col = document.createElement("div");
        col.className = "day-col";
        col.style.height = `calc(${totalSlots} * var(--slot-height))`;
        col.style.gridColumn = (colIdx+2);

        const dayEvents = applyFilters(events).filter(e => e.day===day);
        dayEvents.forEach(ev => {
          const topSlots = (ev.start - gridStart) / SLOT_MINUTES;
          const spanSlots = Math.max(1, (ev.end - ev.start) / SLOT_MINUTES);
          const div = document.createElement("div");
          div.className = "event" + (idsInClash.has(ev.id) ? " clash" : "");
          div.style.top = `calc(${topSlots} * var(--slot-height))`;
          div.style.height = `calc(${spanSlots} * var(--slot-height) - 6px)`;
          const timeLabel = `${mmToHHMM12(ev.start)} â€“ ${mmToHHMM12(ev.end)}`;
          const linkIcon = ev.link ? ` â€¢ <a href="${ev.link}" target="_blank" style="color:var(--accent);text-decoration:underline">Link</a>` : "";
          div.innerHTML = `<div class="title">${escapeHtml(ev.course)} â€¢ Sec ${escapeHtml(ev.section)}</div>
            <div class="meta">${timeLabel} â€¢ ${escapeHtml(ev.teacher)} â€¢ ${escapeHtml(ev.room || "TBA")}${linkIcon}</div>`;
          div.addEventListener("click", () => openEventModal(ev));
          col.appendChild(div);
        });

        // Badges: only for clusters of conflicting events
        const clusters = conflictClustersByDay[day] || [];
        clusters.forEach(cl => {
          const topSlots = (cl.start - gridStart) / SLOT_MINUTES;
          const badge = document.createElement("div");
          badge.className = "count-badge clash";
          badge.style.top = `calc(${topSlots} * var(--slot-height))`;
          badge.textContent = cl.members.length;
          badge.title = "Click to view conflicting items";
          badge.addEventListener("click", () => openClusterModal(day, cl));
          col.appendChild(badge);
        });

        cal.appendChild(col);
      });

      // After first paint, auto-scale slot height so all text fits vertically
      requestAnimationFrame(adjustSlotHeightToFit);
    }

    function adjustSlotHeightToFit(){
      const eventsEls = Array.from(document.querySelectorAll('.event'));
      if(!eventsEls.length) return;
      let maxRatio = 1;
      for(const el of eventsEls){
        const h = el.offsetHeight;
        const contentH = el.scrollHeight;
        if(contentH > h){
          const ratio = contentH / h;
          if(ratio > maxRatio) maxRatio = ratio;
        }
      }
      if(maxRatio > 1.01){
        const current = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--slot-height'));
        const target = Math.min(current * maxRatio * 1.05, 64); // cap growth
        document.documentElement.style.setProperty('--slot-height', target + "px");
        // re-render with new slot height so positions/heights are consistent
        renderCalendar();
      }
    }

    // ===== Modal =====
    const modal = document.getElementById("modal");
    const modalTitle = document.getElementById("modalTitle");
    const modalContent = document.getElementById("modalContent");
    document.getElementById("closeModal").addEventListener("click", ()=> modal.style.display="none");
    modal.addEventListener("click", (e)=> { if(e.target===modal) modal.style.display="none"; });

    function openEventModal(ev){
      modalTitle.textContent = `${ev.course} â€¢ Sec ${ev.section}`;
      const related = conflicts.filter(c => c.a.id===ev.id || c.b.id===ev.id);
      const rows = related.map(c => {
        const other = c.a.id===ev.id ? c.b : c.a;
        return `<tr>
          <td>${c.type.replace("_"," ")}</td>
          <td>${escapeHtml(c.key || "")}</td>
          <td>${escapeHtml(other.course)} â€¢ Sec ${escapeHtml(other.section)}</td>
          <td>${mmToHHMM12(other.start)}â€“${mmToHHMM12(other.end)}</td>
          <td>${escapeHtml(other.teacher)}</td>
          <td>${escapeHtml(other.room || "TBA")}</td>
        </tr>`;
      }).join("");

      modalContent.innerHTML = `
        <div class="muted">Clashes for this event (${related.length}).</div>
        <table>
          <thead><tr><th>Type</th><th>Key</th><th>With</th><th>Time</th><th>Teacher</th><th>Room</th></tr></thead>
          <tbody>${rows || `<tr><td colspan="6" class="muted">No clashes for this event.</td></tr>`}</tbody>
        </table>
      ` + (related.length ? `<h3>Suggested fixes</h3>${related.map(c=>renderSuggestions(c.suggestions)).join("")}` : "");
      modal.style.display = "flex";
    }

    function openClusterModal(day, cl){
      modalTitle.textContent = `${day} â€¢ Clash window ${mmToHHMM12(cl.start)}â€“${mmToHHMM12(cl.end)}`;
      const rows = cl.members.map(e => `
        <tr>
          <td>${escapeHtml(e.course)} â€¢ Sec ${escapeHtml(e.section)}</td>
          <td>${mmToHHMM12(e.start)}â€“${mmToHHMM12(e.end)}</td>
          <td>${escapeHtml(e.teacher)}</td>
          <td>${escapeHtml(e.room || "TBA")}</td>
        </tr>`).join("");
      modalContent.innerHTML = `
        <div class="muted">These items are in conflict within this window (based on selected clash dimensions).</div>
        <table>
          <thead><tr><th>Item</th><th>Time</th><th>Teacher</th><th>Room</th></tr></thead>
          <tbody>${rows}</tbody>
        </table>`;
      modal.style.display = "flex";
    }

    function renderSuggestions(sug){
      if(!sug) return "";
      const items = [];
      if(sug.alt_room_same_time_for_a) items.push(`<div>Alt rooms at same time (A): ${sug.alt_room_same_time_for_a.map(x=>`<span class="pill">${x}</span>`).join(" ")}</div>`);
      if(sug.alt_room_same_time_for_b) items.push(`<div>Alt rooms at same time (B): ${sug.alt_room_same_time_for_b.map(x=>`<span class="pill">${x}</span>`).join(" ")}</div>`);
      if(sug.next_available_for_a) items.push(`<div>Next available (A): <span class="pill">${sug.next_available_for_a.day} ${sug.next_available_for_a.start}â€“${sug.next_available_for_a.end}</span></div>`);
      if(sug.next_available_for_b) items.push(`<div>Next available (B): <span class="pill">${sug.next_available_for_b.day} ${sug.next_available_for_b.start}â€“${sug.next_available_for_b.end}</span></div>`);
      if(!items.length) items.push(`<div class="muted">No suggestions found.</div>`);
      return `<div style="display:flex; flex-direction:column; gap:6px; margin-top:6px;">${items.join("")}</div>`;
    }

    // ===== Download Conflicts =====
    document.getElementById("btnDownload").addEventListener("click", () => {
      if(!conflicts.length){ alert("No conflicts to download (with current settings)."); return; }
      const rows = [["Conflict Type","Day","Key","Curriculum","Semester","Course A","Section A","Teacher A","Room A","Start A","End A","Course B","Section B","Teacher B","Room B","Start B","End B"]];
      for(const c of conflicts){
        rows.push([
          c.type, c.day, c.key,
          c.a.curriculum, c.a.semester,
          c.a.course, c.a.section, c.a.teacher, c.a.room || "",
          mmToHHMM12(c.a.start), mmToHHMM12(c.a.end),
          c.b.course, c.b.section, c.b.teacher, c.b.room || "",
          mmToHHMM12(c.b.start), mmToHHMM12(c.b.end)
        ]);
      }
      const csv = rows.map(r => r.map(v => `"${(v??"").toString().replace(/"/g,'""')}"`).join(",")).join("\n");
      const blob = new Blob([csv], {type:"text/csv"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "timetable_conflicts.csv";
      a.click();
      URL.revokeObjectURL(a.href);
    });

    // ===== Ask AI integration (OpenAI Responses API) =====
    const aiModal = document.getElementById("aiModal");
    const askAiBtn = document.getElementById("askAiBtn");
    const closeAiModal = document.getElementById("closeAiModal");
    const apiKeyInput = document.getElementById("apiKeyInput");
    const saveKeyBtn = document.getElementById("saveKeyBtn");
    const clearKeyBtn = document.getElementById("clearKeyBtn");
    const askBtn = document.getElementById("askBtn");
    const aiPrompt = document.getElementById("aiPrompt");
    const aiStatus = document.getElementById("aiStatus");
    const aiOutput = document.getElementById("aiOutput");

    function openAi(){
      const saved = localStorage.getItem("openai_api_key") || "";
      apiKeyInput.value = saved;
      aiOutput.textContent = "";
      aiStatus.textContent = "";
      aiModal.style.display = "flex";
    }
    askAiBtn.addEventListener("click", openAi);
    closeAiModal.addEventListener("click", ()=> aiModal.style.display="none");
    aiModal.addEventListener("click", (e)=> { if(e.target===aiModal) aiModal.style.display="none"; });

    saveKeyBtn.addEventListener("click", ()=>{
      if(apiKeyInput.value.trim()){
        localStorage.setItem("openai_api_key", apiKeyInput.value.trim());
        aiStatus.textContent = "Saved âœ“";
        setTimeout(()=> aiStatus.textContent="", 1500);
      }
    });
    clearKeyBtn.addEventListener("click", ()=>{
      localStorage.removeItem("openai_api_key");
      apiKeyInput.value = "";
      aiStatus.textContent = "Cleared âœ“";
      setTimeout(()=> aiStatus.textContent="", 1500);
    });

    function buildContext(max=60){
      const f = getFilters();
      const filtered = applyFilters(events).slice(0, max);
      const summary = {
        filters: f,
        totals: { all: events.length, filtered: filtered.length },
        sample_events: filtered.map(e => ({
          curriculum: e.curriculum, semester: e.semester, course: e.course, section: e.section,
          teacher: e.teacher, room: e.room, day: e.day, start: mmToHHMM12(e.start), end: mmToHHMM12(e.end)
        }))
      };
      return summary;
    }

    async function askOpenAI(){
      const key = (apiKeyInput.value.trim() || localStorage.getItem("openai_api_key") || "").trim();
      if(!key){ aiStatus.textContent = "Enter your API key."; return; }
      const q = aiPrompt.value.trim();
      if(!q){ aiStatus.textContent = "Type a question."; return; }
      aiStatus.textContent = "Thinkingâ€¦";
      aiOutput.textContent = "";

      const context = buildContext(80);

      // Prefer Responses API; fall back to Chat Completions if needed
      const payload = {
        model: "gpt-4o-mini",
        input: `You are a helpful assistant for timetable analysis.\nUser question: ${q}\n\nHere is the current timetable context as JSON (may be truncated):\n${JSON.stringify(context)}`
      };

      try{
        const r = await fetch("https://api.openai.com/v1/responses", {
          method: "POST",
          headers: { "Content-Type": "application/json", "Authorization": "Bearer " + key },
          body: JSON.stringify(payload)
        });
        if(!r.ok){
          const txt = await r.text();
          throw new Error(`HTTP ${r.status}: ${txt.slice(0,300)}`);
        }
        const data = await r.json();
        const text = data.output_text || (data.output?.map(p => (p.content||[]).map(c => c.text||"").join("")).join("\n")) || "";
        aiOutput.textContent = text || "(No text returned)";
        aiStatus.textContent = "";
      }catch(err){
        // Fallback to Chat Completions if Responses fails or CORS blocked
        try{
          const r2 = await fetch("https://api.openai.com/v1/chat/completions", {
            method: "POST",
            headers: { "Content-Type": "application/json", "Authorization": "Bearer " + key },
            body: JSON.stringify({
              model: "gpt-4o-mini",
              messages: [
                {role:"system", content:"You are a helpful assistant for timetable analysis."},
                {role:"user", content: `${q}\n\nContext JSON (may be truncated):\n${JSON.stringify(context)}`}
              ]
            })
          });
          if(!r2.ok){
            const txt = await r2.text();
            throw new Error(`HTTP ${r2.status}: ${txt.slice(0,300)}`);
          }
          const data2 = await r2.json();
          const text2 = data2.choices?.[0]?.message?.content || "";
          aiOutput.textContent = text2 || "(No text returned)";
          aiStatus.textContent = "";
        }catch(err2){
          aiStatus.textContent = "Error";
          aiOutput.textContent = `Could not call OpenAI.\n${(err2 && err2.message) || err?.message || err2}\n\nIf this is a CORS error, use a small server proxy in production.`;
        }
      }
    }
    document.getElementById("askBtn").addEventListener("click", askOpenAI);

    // Keep days bar mode synced after dynamic calendar height changes
    window.addEventListener("scroll", updateDaysBarMode);
  </script>
</body>
</html>
